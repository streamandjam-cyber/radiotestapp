
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>tapis volant</title>

  <link rel="stylesheet" href="css/style.css">

  <!-- Redirection mobile -->
  <script>
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    if (isMobile) {
      document.location.href = "index_mobile.html";
    }
  </script>

  <!-- Librairies -->
  <script src="lib/jquery-1.12.4.min.js"></script>
  <script src="lib/matter.min.js"></script>
  <script src="lib/matter-dom-plugin.min.js"></script>
  <script src="js/script_physique.js"></script>
  <script src="js/script_interaction.js"></script>
</head>

<body>
  <div id="debug"></div>

  <div matter id="titre" data-x-percent="50" data-y-percent="20" data-masse="1" data-friction="1" data-frictionair="0.1" data-rebond="0.01" data-fixe="false">
    <div id="current-song">Chargement…</div>
  </div>

  <div matter id="play" data-x-percent="66" data-y-percent="20" data-masse="1" data-friction="1" data-frictionair="0.1" data-rebond="0.01" data-fixe="false">play</div>
  
  <div matter id="pause" data-x-percent="88" data-y-percent="20" data-masse="1" data-friction="1" data-frictionair="0.1" data-rebond="0.01" data-fixe="false">pause</div>
  
  <div matter id="tapis" data-x-percent="8" data-y-percent="20" data-masse="1" data-friction="1" data-frictionair="0.1" data-rebond="0.01" data-fixe="false">tapis volant</div>

  <div matter id="speaker" data-x-percent="31" data-y-percent="20" data-masse="1" data-friction="1" data-frictionair="0.1" data-rebond="0.01" data-fixe="false">
    <div class="rond" id="plusdevolume"></div>
    <div class="rond" id="moinsdevolume"></div>
  </div>

  <div matter id="playlist" data-x-percent="30" data-y-percent="40" data-masse="3" data-friction="1" data-frictionair="0.1" data-rebond="0.01" data-fixe="false">
    <div class="historique">
      historique :
      <div id="history"></div>
    </div>
  </div>

<div id="changerdestyle">Changer de Style</div>
<div id="plusdechoses">Plus de choses</div>

  <!-- Bords / limites du canevas physique -->
  <div id="sol" class="bordure_h"></div>
  <div id="plafond" class="bordure_h"></div>
  <div id="mur_gauche" class="bordure_v"></div>
  <div id="mur_droite" class="bordure_v"></div>

  <script>
    // "Artiste – Titre" (demi-cadratin)
    function formatArtistTitle(song) {
      const artist = (song?.artist || '').trim();
      const title  = (song?.title  || '').trim();
      if (artist && title) return `${artist} – ${title}`;
      return artist || title || '';
    }

    // Remplit l'historique (6 lignes, sauts de ligne)
    function renderHistory(data) {
      const container = document.getElementById('history');
      if (!container) return;
      container.innerHTML = '';

      const historyArray = data?.song_history || data?.recently_played || [];
      let count = 0;

      for (const item of historyArray) {
        if (count >= 6) break;
        const line = formatArtistTitle(item.song);
        if (!line) continue;
        container.innerHTML += line + '<br>';
        count++;
      }
    }

    // Met à jour morceau en cours + historique
    async function updateSong() {
      try {
        const response = await fetch('https://azura.tapisvolant.net/api/nowplaying/tapis_volant');
        const data = await response.json();

        const current = formatArtistTitle(data?.now_playing?.song);
        document.getElementById('current-song').textContent = current || 'Aucun morceau';

        renderHistory(data);
      } catch (e) {
        console.error(e);
        document.getElementById('current-song').textContent = 'Erreur de lecture';
      }
    }

    updateSong();
    setInterval(updateSong, 3000);
  </script>
</body>
</html>